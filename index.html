<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- ã‚¹ãƒãƒ›å¯¾å¿œ -->
    <title>ã‚¨ãƒªã‚¢ãƒãƒˆãƒ«</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
      body {
        margin: 0;
        font-family: "Orbitron", sans-serif;
        background: #020617;
        color: white;
      }

      /* ===== HUD ===== */
      .hud {
        background: #020617;
        padding: 14px;
        border-radius: 16px;
        margin-bottom: 12px;
        box-shadow: 0 0 15px rgba(0, 200, 255, 0.3);
        text-align: center;
      }

      #result {
        font-size: 20px;
        color: #22d3ee;
        margin-bottom: 10px;
      }

      /* ===== åœ°å›³ ===== */
      #map {
        height: 55vh;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(0, 200, 255, 0.25);
        margin-bottom: 14px;
      }

      /* ===== æ“ä½œãƒœã‚¿ãƒ³ ===== */
      .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
      }

      button {
        width: 100%;
        box-sizing: border-box;
        padding: 16px;
        font-size: 15px;
        border: none;
        border-radius: 14px;
        background: linear-gradient(90deg, #0ea5e9, #22d3ee);
        color: white;
        font-weight: bold;
        letter-spacing: 1px;
        box-shadow: 0 0 12px rgba(34, 211, 238, 0.4);
      }

      button:active {
        transform: scale(0.94);
      }

      /* ===== ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ ===== */
      .ranking-board {
        background: #020617;
        border-radius: 16px;
        padding: 14px;
        box-shadow: 0 0 12px rgba(0, 200, 255, 0.2);
      }

      .rank-item {
        display: flex;
        justify-content: space-between;
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 10px;
        border: 1px solid rgba(0, 200, 255, 0.3);
      }

      .rank-item:first-child {
        border: 1px solid gold;
        box-shadow: 0 0 12px gold;
      }
    </style>
  </head>

  <body>
    <div class="header">Area Battle</div>
    <div class="container">
      <div class="hud">
        <!--hud:ã‚²ãƒ¼ãƒ ã®ä¸Šéƒ¨æƒ…å ±æ¬„-->
        <div id="result">é¢ç©: 0</div>
        <input id="username" type="text" placeholder="PLAYER NAME" />
      </div>
      <div id="map" style="height: 500px"></div>
      <div class="action-buttons">
        <button onclick="startGPS()">GPSå–å¾—é–‹å§‹</button>
        <button onclick="sendArea()">é¢ç©è¨ˆç®—</button>
        <button onclick="resetMap()">åœ°å›³ãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <div class="card ranking-board">
        <h3>ğŸ† SCORE BOARD</h3>
        <div id="ranking"></div>
      </div>
    </div>

    <script>
      // åœ°å›³ã‚’ä½œã‚‹ã€‚ç¦å²¡ã‚ãŸã‚Šã‚’è¡¨ç¤º
      let map = L.map("map", {
        dragging: true, // ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•æœ‰åŠ¹
        touchZoom: true, // ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ æœ‰åŠ¹
        scrollWheelZoom: true, // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã‚ºãƒ¼ãƒ æœ‰åŠ¹
        doubleClickZoom: true, // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚ºãƒ¼ãƒ æœ‰åŠ¹
        boxZoom: true, // ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚ºãƒ¼ãƒ ç¯„å›²æŒ‡å®šæœ‰åŠ¹
        keyboard: true, // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œæœ‰åŠ¹
      }).setView([35.68, 139.76], 13);

      const playerIcon = L.icon({
        iconUrl: "/static/Player.png", // ä»®ã‚¢ã‚¤ã‚³ãƒ³
        iconSize: [40, 40],
        iconAnchor: [20, 20],
      });

      // ã‚µã‚¤ã‚ºå†è¨ˆç®—ï¼ˆã‚¹ãƒãƒ›ç”»é¢è¡¨ç¤ºå´©ã‚Œé˜²æ­¢ï¼‰
      window.addEventListener("resize", () => {
        map.invalidateSize();
      });

      // æœ€åˆã®1å›ã ã‘åœ°å›³ä¸­å¿ƒã‚’ç¾åœ¨åœ°ã«ç§»å‹•ã™ã‚‹ç”¨
      let firstMove = true;

      // ç„¡æ–™åœ°å›³ã‚’çµ„ã¿è¾¼ã‚€
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(
        map,
      );

      // åº§æ¨™ç”¨ã®é…åˆ—ã¨ã€ç·šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨æ„
      let points = [];
      let polyline = L.polyline([]).addTo(map);
      let closeline = null;
      let polygonLayer = null; // å¤šè§’å½¢ã®è‰²å¡—ã‚Š

      // ã‚¯ãƒªãƒƒã‚¯ã§åº§æ¨™è¿½åŠ ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
      /*map.on('click', function(e){
    points.push([e.latlng.lng, e.latlng.lat]);
    polyline.addLatLng(e.latlng); // ç·šã‚’è¿½åŠ ã§ä¼¸ã°ã™
});*/

      let lastLat = null;
      let lastLng = null;

      // ç°¡æ˜“è·é›¢è¨ˆç®—ï¼ˆâ€»ç·¯åº¦çµŒåº¦ã®å·®ã®å¤§ãã•ï¼‰
      function distance(a, b, c, d) {
        return Math.sqrt((a - c) ** 2 + (b - d) ** 2);
      }

      async function sendArea() {
        if (points.length < 3) {
          alert("3ç‚¹ä»¥ä¸Šå¿…è¦ã§ã™ã€‚");
          return;
        }

        // æ—¢å­˜ã®ç‚¹ç·šå‰Šé™¤
        if (closeline) {
          map.removeLayer(closeline);
          closeline = null;
        }

        // å§‹ç‚¹çµ‚ç‚¹ã‚’ç‚¹ç·šã§çµã¶
        let start = points[0];
        let end = points[points.length - 1];
        closeline = L.polyline(
          [
            [start[1], start[0]],
            [end[1], end[0]],
          ],
          {
            dashArray: "8,8", // ç‚¹ç·š
            color: "#00fff7",
            weight: 3,
          },
        ).addTo(map);

        // æœ€åˆã®ç‚¹ã‚’æœ€å¾Œã«è¿½åŠ ã—ã¦ã€å¤šè§’å½¢ã‚’é–‰ã˜ã‚‹
        let sendPoints = [...points]; // é…åˆ—ã®ã‚³ãƒ”ãƒ¼

        let first = sendPoints[0];
        let last = sendPoints[sendPoints.length - 1];

        if (first[0] !== last[0] || first[1] !== last[1]) {
          sendPoints.push(first); // å§‹ç‚¹ã¨çµ‚ç‚¹ãŒä¸€è‡´ã—ã¦ã„ãªã‘ã‚Œã°ã€ã“ã“ã§æœ€åˆã®ç‚¹ã‚’æœ€å¾Œã«è¿½åŠ 
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—
        let name = document.getElementById("username").value;
        if (!name) {
          alert("PLAYER NAMEã‚’å…¥åŠ›ã—ã¦ã­");
          return;
        }

        //ã€€fetchã§ã€ã‚µãƒ¼ãƒãƒ¼ã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦é¢ç©ã‚’å–å¾—
        let res = await fetch("https://area-battle.onrender.com/area", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            coords: sendPoints,
            name: name,
          }), // åº§æ¨™ãƒ»åå‰ãƒ‡ãƒ¼ã‚¿é€ä¿¡(JS â†’ JSON â†’ Python)
        });

        let data = await res.json(); //ã€€é¢ç©ãƒ‡ãƒ¼ã‚¿å—ä¿¡(Python â†’ JSON â†’ JS)
        // â†‘ data = { "area": é¢ç©ã®æ•°å€¤ } ã¨ã„ã†æ§‹é€ ã§å—ã‘å–ã‚Œã‚‹
        document.getElementById("result").innerText = "é¢ç©: " + data.area;

        if (polygonLayer) {
          map.removeLayer(polygonLayer); //æ—¢å­˜ã®å¤šè§’å½¢ã‚’å‰Šé™¤
        }
        polygonLayer = L.polygon(
          points.map((p) => [p[1], p[0]]),
          {
            color: "#adff2f", // ç·šã®è‰²
            fillColor: "#adff2f", // å¡—ã‚Šã¤ã¶ã—ã®è‰²ï¼ˆé»„ç·‘è‰²ï¼‰
            fillOpacity: 0.3,
          },
        ).addTo(map);

        loadRanking(); // ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
      }

      function resetMap() {
        // GPSç›£è¦–åœæ­¢
        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
        }
        // åº§æ¨™ãƒªã‚¹ãƒˆã‚’ç©ºã«
        points = [];
        lastLat = null;
        lastLng = null;
        firstMove = true;
        // ç·šã‚’å‰Šé™¤
        polyline.setLatLngs([]);
        // ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
        if (marker) {
          map.removeLayer(marker);
          marker = null;
        }
        // ç‚¹ç·šã‚’å‰Šé™¤
        if (closeline) {
          map.removeLayer(closeline);
          closeline = null;
        }
        // å¤šè§’å½¢ã‚’å‰Šé™¤
        if (polygonLayer) {
          map.removeLayer(polygonLayer);
        }
        // çµæœè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
        document.getElementById("result").innerText = "";
      }

      // GPSé–¢é€£
      let watchId = null; // ç›£è¦–ID
      let marker = null; // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼

      function startGPS() {
        // GPSå¯¾å¿œç¢ºèª
        if (!navigator.geolocation) {
          alert("GPSãŒã¤ã‹ãˆãªã„ã‚ˆ");
          return;
        }

        // GPSäºŒé‡èµ·å‹•é˜²æ­¢
        if (watchId) {
          alert("ã™ã§ã«é–‹å§‹ã—ã¦ã‚‹ã‚ˆ");
          return;
        }

        // ä½ç½®æƒ…å ±ç›£è¦–é–‹å§‹
        watchId = navigator.geolocation.watchPosition(
          function (pos) {
            // lat: ç·¯åº¦ã€lng: çµŒåº¦ã‚’å–å¾—
            let lat = pos.coords.latitude;
            let lng = pos.coords.longitude;

            if (lastLat !== null) {
              // ã‚ã¾ã‚Šã«è¿‘ã„å ´åˆã¯ç„¡è¦–ã—ã¦è¿½åŠ ã—ãªã„ï¼ˆãƒã‚¤ã‚ºå¯¾ç­–ï¼‰
              if (distance(lat, lng, lastLat, lastLng) < 0.00005) {
                return;
              }
            }

            // æ›´æ–°
            lastLat = lat;
            lastLng = lng;

            // é¢ç©è¨ˆç®—ç”¨ã®å½¢å¼(çµŒåº¦ã€ç·¯åº¦)ã§é…åˆ—ã«è¿½åŠ 
            points.push([lng, lat]);

            // åœ°å›³è¡¨ç¤ºç”¨(ç·¯åº¦ã€çµŒåº¦)ã§ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
            polyline.addLatLng([lat, lng]);

            // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°
            if (marker) {
              marker.setLatLng([lat, lng]);
            } else {
              marker = L.marker([lat, lng], { icon: playerIcon }).addTo(map);
            }

            L.circle([lat, lng], {
              radius: 3,
              color: "#00fff7",
              fillColor: "#00fff7",
              fillOpacity: 0.7,
            }).addTo(map);

            // åœ°å›³ä¸­å¿ƒã‚’ç¾åœ¨åœ°ã«ç§»å‹•ï¼ˆåˆå›ã®ã¿ï¼‰
            if (firstMove) {
              map.panTo([lat, lng]);
              firstMove = false;
            }
          },
          function (err) {
            alert("ä½ç½®æƒ…å ±å–å¾—å¤±æ•—");
          },
          {
            enableHighAccuracy: true, // é«˜ç²¾åº¦ãƒ¢ãƒ¼ãƒ‰ã€‚ã§ãã‚‹ã ã‘é »ç¹ã«ä½ç½®æƒ…å ±ã‚’æ›´æ–°ã€‚
            maximumAge: 0, // æ¯å›æ–°ã—ã„æƒ…å ±ã‚’å–å¾—
            timeout: 10000, // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ10ç§’
          },
        );
      }

      async function loadRanking() {
        let res = await fetch("https://area-battle.onrender.com/ranking");
        let data = await res.json();

        let text = "";
        let rank = 1;

        for (let r of data) {
          if (rank == 1) {
            crown = "ğŸ¥‡";
          } else if (rank == 2) {
            crown = "ğŸ¥ˆ";
          } else if (rank == 3) {
            crown = "ğŸ¥‰";
          } else {
            crown = "";
          }

          text += crown + rank + "ä½ " + r.username + " : " + r.area + "<br>";
          rank++;
        }
        document.getElementById("ranking").innerHTML = text;
      }

      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
      loadRanking(); // æœ€åˆã«ä¸€å›å®Ÿè¡Œ
    </script>
  </body>
</html>
