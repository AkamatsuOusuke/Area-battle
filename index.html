<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />

    <meta name="theme-color" content="#00fff7"><!--ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><!-- ã‚¹ãƒãƒ›å¯¾å¿œ -->
    <title>ã‚¨ãƒªã‚¢ãƒãƒˆãƒ«</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="manifest" href="/static/manifest.json"><!--ã‚¢ãƒ—ãƒªè¨­å®š(manifest.js)-->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script> <!--supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—-->

    <style>
      body {
        margin: 0;
        font-family: "Orbitron", sans-serif;
        background: #020617;
        color: white;
      }

      .header{
        text-align:center;
        padding:10px;
        font-size:22px;
      }

      .container{
        padding:10px;
      }

      /* ===== HUD ===== */
      .hud {
        background: #020617;
        padding: 14px;
        border-radius: 16px;
        margin-bottom: 12px;
        box-shadow: 0 0 15px rgba(0, 200, 255, 0.3);
        text-align: center;
      }

      #titleScreen{
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          gap: 12px; /* ãƒœã‚¿ãƒ³ã‚„å…¥åŠ›é–“ã®ç¸¦é–“éš”ã‚’çµ±ä¸€ */
      }

      .title-btn{
          padding: 16px 30px;
          font-size: 18px;
          border-radius: 14px;
          background: linear-gradient(90deg, #31bb91, #22d3ee);
          border: none;
          color: black;
          width: 200px; /* æ¨ªå¹…ã‚’çµ±ä¸€ */
      }

      #result {
        font-size: 20px;
        color: #22d3ee;
        margin-bottom: 10px;
      }

      /* ===== åœ°å›³ ===== */
      #map {
        height: 55vh;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(0, 200, 255, 0.25);
        margin-bottom: 14px;
      }

      /* ===== æ“ä½œãƒœã‚¿ãƒ³ ===== */
      .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
      }

      button {
        width: 100%;
        box-sizing: border-box;
        padding: 16px;
        font-size: 15px;
        border: none;
        border-radius: 14px;
        background: linear-gradient(90deg, #0ea5e9, #22d3ee);
        color: white;
        font-weight: bold;
        letter-spacing: 1px;
        box-shadow: 0 0 12px rgba(34, 211, 238, 0.4);
      }

      button:active {
        transform: scale(0.94);
      }

      /* ===== ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ ===== */
      .ranking-board {
        background: #020617;
        border-radius: 16px;
        padding: 14px;
        box-shadow: 0 0 12px rgba(0, 200, 255, 0.2);
      }

      .rank-item {
        display: flex;
        justify-content: space-between;
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 10px;
        border: 1px solid rgba(0, 200, 255, 0.3);
      }

      .rank-item:first-child {
        border: 1px solid gold;
        box-shadow: 0 0 12px gold;
      }
    </style>
  </head>

  <body>
    <!--ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢-->
    <div id="titleScreen" style="
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:#020617;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    z-index:9999;
    ">

    <h1 style="font-size:40px;color:#22ee77;">AREA BATTLE</h1>

    <input id="titlename" type="text" placeholder="PLAYER NAME"
    style="
    padding:12px;
    margin:20px;
    border-radius:
    10px;border:none;
    text-align:center;
    font-size:16px;"
    >

    <button class="title-btn" onclick="startGame()">GPSé–‹å§‹</button>

    <button class="title-btn" onclick="signUp()">æ–°è¦ç™»éŒ²</button>

    <button class="title-btn" onclick="signIn()">ãƒ­ã‚°ã‚¤ãƒ³</button>

    <button id="installBtn" style="
    display:none;
    margin:10px auto;
    padding:12px 24px;
    font-size:16px;
    border-radius:14px;
    border:none;
    background:linear-gradient(90deg,#ff9900,#ffcc33);
    color:black;
    font-weight:bold;
    cursor:pointer;
    width:200px
    ">ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>

    </div>

    <div class="header">Area Battle</div>
    <div class="container">
      <div class="hud">
        <!--hud:ã‚²ãƒ¼ãƒ ã®ä¸Šéƒ¨æƒ…å ±æ¬„-->
        <div id="result">é¢ç©: 0</div>
        <input id="username" type="text" placeholder="PLAYER NAME" style="text-align:center;"/>
      </div>
      <div id="map" style="height: 500px"></div>
      <div class="action-buttons">
        <button onclick="sendArea()">é¢ç©è¨ˆç®—</button>
        <button onclick="resetMap()">åœ°å›³ãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <div class="card ranking-board">
        <h3>ğŸ† SCORE BOARD</h3>
        <div id="ranking"></div>
      </div>
    </div>

    <script>

      // supabase åˆæœŸåŒ–
      const SUPABASE_URL = "https://jysjolovimtyvimkhfpd.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5c2pvbG92aW10eXZpbWtoZnBkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MDA5MzQsImV4cCI6MjA4NjI3NjkzNH0.YDrF0H_mq99R5LIhcFVe4EAc-Z0ZwyB-WUH9XwdqDTo";
      const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—(æ–°è¦ç™»éŒ²)
      async function signUp(){
          const email = prompt("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›");
          const password = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›");

          if (!email || !password) {
            alert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™");
            return;
          }

          const { data, error } = await sb.auth.signUp({
            email: email,
            password: password,
          });// ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’supabaseã«ç™»éŒ²

          if (error) {
            alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + error.message);
          } else {
            alert("ç™»éŒ²æˆåŠŸï¼ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
          }
      }

      // ã‚µã‚¤ãƒ³ã‚¤ãƒ³(ãƒ­ã‚°ã‚¤ãƒ³)
      async function signIn(){
          const email = prompt("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›");
          const password = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›");

          if (!email || !password) {
              alert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™");
              return;
          }

          const { data, error } = await sb.auth.signInWithPassword({
              email: email,
              password: password,
          });// å…¥åŠ›ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³

           if (error) {
              alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: " + error.message);
          } else {
              alert("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ã‚ˆã†ã“ã " + data.user.email);
              document.getElementById("username").value = data.user.email; // HUDã«ã‚³ãƒ”ãƒ¼
              document.getElementById("titleScreen").style.display = "none"; // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢æ¶ˆã™
              startGPS(); // GPSé–‹å§‹
          }
      }
      
      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç¢ºèª
      async function checkLogin() {
          const { data } = await sb.auth.getSession();
          if (data.session) {
            // ã™ã§ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿
            document.getElementById("username").value = data.session.user.email;
            document.getElementById("titleScreen").style.display = "none";
            startGPS();
          }
      }// ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª

      checkLogin();


      // åœ°å›³ã‚’ä½œã‚‹ã€‚æ±äº¬ã‚’è¡¨ç¤º
      let map = L.map("map", {
        dragging: true, // ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•æœ‰åŠ¹
        touchZoom: true, // ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ æœ‰åŠ¹
        scrollWheelZoom: true, // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã‚ºãƒ¼ãƒ æœ‰åŠ¹
        doubleClickZoom: true, // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚ºãƒ¼ãƒ æœ‰åŠ¹
        boxZoom: true, // ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚ºãƒ¼ãƒ ç¯„å›²æŒ‡å®šæœ‰åŠ¹
        keyboard: true, // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œæœ‰åŠ¹
      }).setView([35.68, 139.76], 13);

      // ã‚¢ã‚¤ã‚³ãƒ³
      const playerIcon = L.icon({
        iconUrl: "/static/Player.png", // ä»®ã‚¢ã‚¤ã‚³ãƒ³
        iconSize: [40, 40],
        iconAnchor: [20, 40], //ã‚¢ã‚¤ã‚³ãƒ³ã®ä½ç½®ã€‚å°‘ã—ä¸Šã«
      });

      // ã‚µã‚¤ã‚ºå†è¨ˆç®—ï¼ˆã‚¹ãƒãƒ›ç”»é¢è¡¨ç¤ºå´©ã‚Œé˜²æ­¢ï¼‰
      window.addEventListener("resize", () => {
        map.invalidateSize();
      });

      // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³è¡¨ç¤º
      let installPrompt = null;
      const installBtn = document.getElementById("installBtn");
      installBtn.style.display = "none"; // åˆæœŸéè¡¨ç¤º

      window.addEventListener("beforeinstallprompt", (e) => {
          e.preventDefault();       // è‡ªå‹•è¡¨ç¤ºã‚’æ­¢ã‚ã‚‹
          installPrompt = e;
          installBtn.style.display = "block"; // ãƒœã‚¿ãƒ³è¡¨ç¤º
      });

      //iOS Safariå‘ã‘
      if(navigator.userAgent.match(/iPhone|iPad|iPod/)){
        installBtn.style.display = "block"; // æ‰‹å‹•æ¡ˆå†…ç”¨ã«è¡¨ç¤º
      }

      // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
      installBtn.addEventListener("click", async () => {
        if(installPrompt){
          // Chromeç”¨
          installPrompt.prompt();
          const choice = await installPrompt.userChoice; //ãƒ¦ãƒ¼ã‚¶ãŒã€Œã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹/ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã‚’é¸ã‚“ã çµæœã‚’å¾…ã¤
          console.log(choice.outcome === "accepted" ? "PWAãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸ" : "ã‚­ãƒ£ãƒ³ã‚»ãƒ«");
          installPrompt = null; // ä¸€åº¦ä½¿ã£ãŸã‚‰å†åº¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ãªã„ã‚ˆã†ã«
          installBtn.style.display = "none"; // ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        } else if(navigator.userAgent.match(/iPhone|iPad|iPod/)){
          // iOS Safariç”¨
          alert("å…±æœ‰ â†’ ã€ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™");
        } else {
          // ãã‚Œä»¥å¤–
          alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ãã ã•ã„");
        }
      });

      // æœ€åˆã®1å›ã ã‘åœ°å›³ä¸­å¿ƒã‚’ç¾åœ¨åœ°ã«ç§»å‹•ã™ã‚‹ç”¨
      let firstMove = true;

      // ç„¡æ–™åœ°å›³ã‚’çµ„ã¿è¾¼ã‚€
      L.tileLayer(
      // è¡›æ˜Ÿå†™çœŸ
      /*"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
      attribution:"Tiles Â© Esri"
      }).addTo(map);*/

      // Dark Matter
      "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
      {
        opacity: 0.7,
        attribution:"Â©OpenStreetMap Â©CartoDB"
      }).addTo(map);

      // åº§æ¨™ç”¨ã®é…åˆ—ã¨ã€ç·šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨æ„
      let points = [];
      let polyline = L.polyline([]).addTo(map);
      let closeline = null;
      let polygonLayer = null; // å¤šè§’å½¢ã®è‰²å¡—ã‚Š

      let lastLat = null;
      let lastLng = null;

      // ç°¡æ˜“è·é›¢è¨ˆç®—ï¼ˆâ€»ç·¯åº¦çµŒåº¦ã®å·®ã®å¤§ãã•ï¼‰
      function distance(a, b, c, d) {
        return Math.sqrt((a - c) ** 2 + (b - d) ** 2);
      }

      // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢
      function startGame(){
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—
        let name = document.getElementById("titlename").value;
        if (!name) {
          alert("PLAYER NAMEã‚’å…¥åŠ›ã—ã¦ã­");
          return;
        }

        // HUDã®åå‰æ¬„ã«ã‚³ãƒ”ãƒ¼
        document.getElementById("username").value = name;

        // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢æ¶ˆã™
        document.getElementById("titleScreen").style.display = "none";

        // GPSé–‹å§‹
        startGPS();
      }

      // é¢ç©è¨ˆç®—ç”¨
      async function sendArea() {
        if (points.length < 3) {
          alert("3ç‚¹ä»¥ä¸Šå¿…è¦ã§ã™ã€‚");
          return;
        }

        // æ—¢å­˜ã®ç‚¹ç·šå‰Šé™¤
        if (closeline) {
          map.removeLayer(closeline);
          closeline = null;
        }

        // å§‹ç‚¹çµ‚ç‚¹ã‚’ç‚¹ç·šã§çµã¶
        let start = points[0];
        let end = points[points.length - 1];
        closeline = L.polyline(
          [
            [start[1], start[0]],
            [end[1], end[0]],
          ],
          {
            dashArray: "8,8", // ç‚¹ç·š
            color: "#00fff7",
            weight: 3,
          },
        ).addTo(map);

        // æœ€åˆã®ç‚¹ã‚’æœ€å¾Œã«è¿½åŠ ã—ã¦ã€å¤šè§’å½¢ã‚’é–‰ã˜ã‚‹
        let sendPoints = [...points]; // é…åˆ—ã®ã‚³ãƒ”ãƒ¼

        let first = sendPoints[0];
        let last = sendPoints[sendPoints.length - 1];

        if (first[0] !== last[0] || first[1] !== last[1]) {
          sendPoints.push(first); // å§‹ç‚¹ã¨çµ‚ç‚¹ãŒä¸€è‡´ã—ã¦ã„ãªã‘ã‚Œã°ã€ã“ã“ã§æœ€åˆã®ç‚¹ã‚’æœ€å¾Œã«è¿½åŠ 
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—
        let name = document.getElementById("username").value;
        if (!name) {
          alert("PLAYER NAMEã‚’å…¥åŠ›ã—ã¦ã­");
          return;
        }

        //ã€€fetchã§ã€ã‚µãƒ¼ãƒãƒ¼ã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦é¢ç©ã‚’å–å¾—
        let res = await fetch("https://area-battle.onrender.com/area", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            coords: sendPoints,
            name: name,
          }), // åº§æ¨™ãƒ»åå‰ãƒ‡ãƒ¼ã‚¿é€ä¿¡(JS â†’ JSON â†’ Python)
        });

        let data = await res.json(); //ã€€é¢ç©ãƒ‡ãƒ¼ã‚¿å—ä¿¡(Python â†’ JSON â†’ JS)
        // â†‘ data = { "area": é¢ç©ã®æ•°å€¤ } ã¨ã„ã†æ§‹é€ ã§å—ã‘å–ã‚Œã‚‹
        document.getElementById("result").innerText = "é¢ç©: " + data.area;

        if (polygonLayer) {
          map.removeLayer(polygonLayer); //æ—¢å­˜ã®å¤šè§’å½¢ã‚’å‰Šé™¤
        }
        polygonLayer = L.polygon(
          points.map((p) => [p[1], p[0]]),
          {
            color: "#adff2f", // ç·šã®è‰²
            fillColor: "#adff2f", // å¡—ã‚Šã¤ã¶ã—ã®è‰²ï¼ˆé»„ç·‘è‰²ï¼‰
            fillOpacity: 0.3,
          },
        ).addTo(map);

        loadRanking(); // ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
      }

      // åœ°å›³ãƒªã‚»ãƒƒãƒˆç”¨
      function resetMap() {

        // åº§æ¨™ãƒªã‚¹ãƒˆã‚’ç©ºã«
        points = [];
        lastLat = null;
        lastLng = null;
        firstMove = true;
        // ç·šã‚’å‰Šé™¤
        polyline.setLatLngs([]);

        // å††ã‚’å‰Šé™¤
        for(let c of circles){
          map.removeLayer(c);
        }
        circles = [];
        // ç‚¹ç·šã‚’å‰Šé™¤
        if (closeline) {
          map.removeLayer(closeline);
          closeline = null;
        }
        // å¤šè§’å½¢ã‚’å‰Šé™¤
        if (polygonLayer) {
          map.removeLayer(polygonLayer);
        }
        // çµæœè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
        document.getElementById("result").innerText = "";
      }

      // GPSé–¢é€£
      let watchId = null; // ç›£è¦–ID
      let marker = null; // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼
      let circles = [];

      // GPSã‚¹ã‚¿ãƒ¼ãƒˆ
      function startGPS() {
        // GPSå¯¾å¿œç¢ºèª
        if (!navigator.geolocation) {
          alert("GPSãŒã¤ã‹ãˆãªã„ã‚ˆ");
          return;
        }

        // GPSäºŒé‡èµ·å‹•é˜²æ­¢
        if (watchId) {
          alert("ã™ã§ã«é–‹å§‹ã—ã¦ã‚‹ã‚ˆ");
          return;
        }

        // ä½ç½®æƒ…å ±ç›£è¦–é–‹å§‹
        watchId = navigator.geolocation.watchPosition(
          function (pos) {
            // lat: ç·¯åº¦ã€lng: çµŒåº¦ã‚’å–å¾—
            let lat = pos.coords.latitude;
            let lng = pos.coords.longitude;

            if (lastLat !== null) {
              // ã‚ã¾ã‚Šã«è¿‘ã„å ´åˆã¯ç„¡è¦–ã—ã¦è¿½åŠ ã—ãªã„ï¼ˆãƒã‚¤ã‚ºå¯¾ç­–ï¼‰
              if (distance(lat, lng, lastLat, lastLng) < 0.00005) {
                return;
              }
            }

            // æ›´æ–°
            lastLat = lat;
            lastLng = lng;

            // é¢ç©è¨ˆç®—ç”¨ã®å½¢å¼(çµŒåº¦ã€ç·¯åº¦)ã§é…åˆ—ã«è¿½åŠ 
            points.push([lng, lat]);

            // åœ°å›³è¡¨ç¤ºç”¨(ç·¯åº¦ã€çµŒåº¦)ã§ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
            polyline.addLatLng([lat, lng]);

            // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°
            if (marker) {
              marker.setLatLng([lat, lng]);
            } else {
              marker = L.marker([lat, lng], { icon: playerIcon }).addTo(map);
            }

            let c = L.circle([lat, lng], {
              radius: 2,
              color: "#00fff7",
              fillColor: "#00fff7",
              fillOpacity: 0.7,
            }).addTo(map);

            circles.push(c);

            // åœ°å›³ä¸­å¿ƒã‚’ç¾åœ¨åœ°ã«ç§»å‹•ï¼ˆåˆå›ã®ã¿ï¼‰
            if (firstMove) {
              map.panTo([lat, lng]);
              firstMove = false;
            }
          },
          function (err) {
            alert("ä½ç½®æƒ…å ±å–å¾—å¤±æ•—");
          },
          {
            enableHighAccuracy: true, // é«˜ç²¾åº¦ãƒ¢ãƒ¼ãƒ‰ã€‚ã§ãã‚‹ã ã‘é »ç¹ã«ä½ç½®æƒ…å ±ã‚’æ›´æ–°ã€‚
            maximumAge: 0, // æ¯å›æ–°ã—ã„æƒ…å ±ã‚’å–å¾—
            timeout: 10000, // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ10ç§’
          },
        );
      }

      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°ç”¨
      async function loadRanking() {
        let res = await fetch("https://area-battle.onrender.com/ranking");
        let data = await res.json();

        let text = "";
        let rank = 1;

        for (let r of data) {
          if (rank == 1) {
            crown = "ğŸ¥‡";
          } else if (rank == 2) {
            crown = "ğŸ¥ˆ";
          } else if (rank == 3) {
            crown = "ğŸ¥‰";
          } else {
            crown = "";
          }

          text += crown + rank + "ä½ " + r.username + " : " + r.area + "<br>";
          rank++;
        }
        document.getElementById("ranking").innerHTML = text;
      }

      loadRanking(); // æœ€åˆã«ä¸€å›å®Ÿè¡Œ


       // ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ãŸã¨ã
      window.addEventListener("pagehide", () => {
        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
        }
      });

      // ç”»é¢ãŒè£ã«å›ã£ãŸã¨ã
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          firstMove = true;
        }
      });

    </script>

    <script>
    if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/static/sw.js");
    }
    </script>


  </body>
</html>
