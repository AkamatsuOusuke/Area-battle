<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- ã‚¹ãƒãƒ›å¯¾å¿œ -->
<title>ã‚¨ãƒªã‚¢ãƒãƒˆãƒ«</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet"> 
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
    /* å…¨ä½“è¨­å®š */
    body{
        margin:0;
        font-family:"Noto Sans JP",sans-serif;
        background:#0f172a;
        color:white;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header{
        position:fixed;
        top:0;
        width:100%;
        background:#020617;
        text-align:center;
        padding:16px;
        font-size:20px;
        z-index:1000;

        font-family:"Orbitron", sans-serif;
        letter-spacing:2px;
        color:#38bdf8;
        text-shadow:0 0 8px rgba(56,189,248,0.7);
        box-shadow:0 0 12px rgba(56,189,248,0.3);
       
    }

    /* ã‚³ãƒ³ãƒ†ãƒŠ */
    .container{
        padding:80px 14px 20px;
        max-width:500px;
        margin:auto;
   }

    /* åœ°å›³ */
    #map{
        height:55vh;
        border-radius:16px;
        overflow:hidden;
        box-shadow:0 0 15px rgba(56,189,248,0.25);
        margin-bottom:14px;
    }

    /* ãƒœã‚¿ãƒ³ */
    button{
       width:100%;
        padding:14px;
        font-size:16px;
        border:none;    
        border-radius:14px;
        background:linear-gradient(90deg,#0ea5e9,#22d3ee);
        color:white;
        font-weight:bold;
        font-family:"Orbitron", sans-serif;
        letter-spacing:1px;
        margin-bottom:10px;
        box-shadow:0 0 10px rgba(34,211,238,0.4);
        transition:0.15s;
    }

    button:active{
        transform:scale(0.96);
        box-shadow:0 0 18px rgba(34,211,238,0.8);
    }

    /* å…¥åŠ› */
    input{
        width:100%;
        padding:14px;
        border-radius:12px;
        border:1px solid rgba(56,189,248,0.3);
        margin-bottom:12px;
        font-size:15px;
        background:#020617;
        color:white;
    }

    /* ã‚«ãƒ¼ãƒ‰ */
    .card{
        background:#020617;
        padding:14px;
        border-radius:16px;
        margin-bottom:14px;
        box-shadow:0 0 12px rgba(56,189,248,0.15);
    }

    /* ãƒ©ãƒ³ã‚­ãƒ³ã‚° */
    .rank-item{
        display:flex;
        justify-content:space-between;
        padding:12px;
        background:#020617;
        border-radius:12px;
        margin-bottom:8px;
        border:1px solid rgba(56,189,248,0.2);
        font-family:"Orbitron", sans-serif;
    }

</style>
</head>

<body>

<div class="header">Area Battle</div>
<div class="container">
    <div id="map" style="height:500px;"></div>
    <input id = "username" type="text" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ "/>
    <button onclick="startGPS()">GPSå–å¾—é–‹å§‹</button>    
    <button onclick="sendArea()">é¢ç©è¨ˆç®—</button>
    <button onclick="resetMap()">åœ°å›³ãƒªã‚»ãƒƒãƒˆ</button>

    <div id="result" class="card"></div>

    <div class="card">
        <h3>ãƒ©ãƒ³ã‚­ãƒ³ã‚° </h3>
        <div id="ranking"></div>
    </div>
</div>



<script>
// åœ°å›³ã‚’ä½œã‚‹ã€‚ç¦å²¡ã‚ãŸã‚Šã‚’è¡¨ç¤º
let map = L.map('map',{
    dragging:true, // ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•æœ‰åŠ¹
    touchZoom:true,  // ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ æœ‰åŠ¹
    scrollWheelZoom:true, // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã‚ºãƒ¼ãƒ æœ‰åŠ¹
    doubleClickZoom:true, // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚ºãƒ¼ãƒ æœ‰åŠ¹
    boxZoom:true, // ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚ºãƒ¼ãƒ ç¯„å›²æŒ‡å®šæœ‰åŠ¹
    keyboard:true // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œæœ‰åŠ¹
}).setView([33.59,130.40],13);

// ã‚µã‚¤ã‚ºå†è¨ˆç®—ï¼ˆã‚¹ãƒãƒ›ç”»é¢è¡¨ç¤ºå´©ã‚Œé˜²æ­¢ï¼‰
window.addEventListener("resize",()=>{
    map.invalidateSize();
})

// æœ€åˆã®1å›ã ã‘åœ°å›³ä¸­å¿ƒã‚’ç¾åœ¨åœ°ã«ç§»å‹•ã™ã‚‹ç”¨
let firstMove = true;

// ç„¡æ–™åœ°å›³ã‚’çµ„ã¿è¾¼ã‚€
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// åº§æ¨™ç”¨ã®é…åˆ—ã¨ã€ç·šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨æ„
let points = [];
let polyline = L.polyline([]).addTo(map);
let closeline = null;

// ã‚¯ãƒªãƒƒã‚¯ã§åº§æ¨™è¿½åŠ ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
/*map.on('click', function(e){
    points.push([e.latlng.lng, e.latlng.lat]);
    polyline.addLatLng(e.latlng); // ç·šã‚’è¿½åŠ ã§ä¼¸ã°ã™
});*/

let lastLat = null;
let lastLng = null;

// ç°¡æ˜“è·é›¢è¨ˆç®—ï¼ˆâ€»ç·¯åº¦çµŒåº¦ã®å·®ã®å¤§ãã•ï¼‰
function distance(a,b,c,d){
    return Math.sqrt((a - c) ** 2 + (b - d) ** 2);
}

async function sendArea(){

    if(points.length < 3){
        alert("3ç‚¹ä»¥ä¸Šå¿…è¦ã§ã™");
        return;
    }

    // æ—¢å­˜ã®ç‚¹ç·šå‰Šé™¤
    if(closeline){
        map.removeLayer(closeline);
        closeline = null;
    }

    // å§‹ç‚¹çµ‚ç‚¹ã‚’ç‚¹ç·šã§çµã¶
    let start = points[0]
    let end = points[points.length-1];
    closeline = L.polyline([[start[1], start[0]], [end[1], end[0]]], 
    {
        dashArray:"8,8", // ç‚¹ç·š
        color: 'red',
        weight:3
    }
    ).addTo(map);

    // æœ€åˆã®ç‚¹ã‚’æœ€å¾Œã«è¿½åŠ ã—ã¦ã€å¤šè§’å½¢ã‚’é–‰ã˜ã‚‹
    let sendPoints = [...points]; // é…åˆ—ã®ã‚³ãƒ”ãƒ¼

    let first = sendPoints[0];
    let last = sendPoints[sendPoints.length-1];

    if(first[0] !== last[0] || first[1] !== last[1]){
        sendPoints.push(first); // å§‹ç‚¹ã¨çµ‚ç‚¹ãŒä¸€è‡´ã—ã¦ã„ãªã‘ã‚Œã°ã€ã“ã“ã§æœ€åˆã®ç‚¹ã‚’æœ€å¾Œã«è¿½åŠ 
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—
    let name = document.getElementById("username").value;
    
    //ã€€fetchã§ã€ã‚µãƒ¼ãƒãƒ¼ã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹
    let res = await fetch("https://area-battle.onrender.com/area",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            coords:sendPoints,
            name:name}) // åº§æ¨™ãƒ»åå‰ãƒ‡ãƒ¼ã‚¿é€ä¿¡(JS â†’ JSON â†’ Python)
    });

    let data = await res.json(); //ã€€é¢ç©ãƒ‡ãƒ¼ã‚¿å—ä¿¡(Python â†’ JSON â†’ JS)
    // â†‘ data = { "area": é¢ç©ã®æ•°å€¤ } ã¨ã„ã†æ§‹é€ ã§å—ã‘å–ã‚Œã‚‹
    document.getElementById("result").innerText =
        "é¢ç©: " + data.area;

    loadRanking(); // ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
}

function resetMap(){
    // GPSç›£è¦–åœæ­¢
    if(watchId !== null){
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }
    // åº§æ¨™ãƒªã‚¹ãƒˆã‚’ç©ºã«
    points = [];
    lastLat = null;
    lastLng = null;
    firstMove = true;
    // ç·šã‚’å‰Šé™¤
    polyline.setLatLngs([]);
    // ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
    if(marker){
        map.removeLayer(marker);
        marker = null;
    }
    // ç‚¹ç·šã‚’å‰Šé™¤
    if(closeline){
        map.removeLayer(closeline);
        closeline = null;
    }
    // çµæœè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
    document.getElementById("result").innerText = "";
}

// GPSé–¢é€£
let watchId = null; // ç›£è¦–ID
let marker = null; // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼

function startGPS(){

    // GPSå¯¾å¿œç¢ºèª
    if(!navigator.geolocation){
        alert("GPSãŒã¤ã‹ãˆãªã„ã‚ˆ");
        return;
    }

    // GPSäºŒé‡èµ·å‹•é˜²æ­¢
    if(watchId){
        alert("ã™ã§ã«é–‹å§‹ã—ã¦ã‚‹ã‚ˆ");
        return;
    }

    // ä½ç½®æƒ…å ±ç›£è¦–é–‹å§‹
    watchId = navigator.geolocation.watchPosition(function(pos){

        // lat: ç·¯åº¦ã€lng: çµŒåº¦ã‚’å–å¾—
        let lat = pos.coords.latitude;
        let lng = pos.coords.longitude;

        if(lastLat !== null){
            // ã‚ã¾ã‚Šã«è¿‘ã„å ´åˆã¯ç„¡è¦–ã—ã¦è¿½åŠ ã—ãªã„ï¼ˆãƒã‚¤ã‚ºå¯¾ç­–ï¼‰
            if(distance(lat,lng,lastLat,lastLng) < 0.00005){
                return;
            }
        }

        // æ›´æ–°
        lastLat = lat;
        lastLng = lng;

        // é¢ç©è¨ˆç®—ç”¨ã®å½¢å¼(çµŒåº¦ã€ç·¯åº¦)ã§é…åˆ—ã«è¿½åŠ 
        points.push([lng, lat]);

        // åœ°å›³è¡¨ç¤ºç”¨(ç·¯åº¦ã€çµŒåº¦)ã§ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
        polyline.addLatLng([lat, lng]);

        // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°
        if(marker){
            marker.setLatLng([lat, lng]);
        }else{
            marker = L.marker([lat, lng]).addTo(map);
        }

        // åœ°å›³ä¸­å¿ƒã‚’ç¾åœ¨åœ°ã«ç§»å‹•ï¼ˆåˆå›ã®ã¿ï¼‰
        if(firstMove){
            map.panTo([lat, lng]);
            firstMove = false;
        }
    },
    function(err){
        alert("ä½ç½®æƒ…å ±å–å¾—å¤±æ•—");
    },
    {
        enableHighAccuracy:true, // é«˜ç²¾åº¦ãƒ¢ãƒ¼ãƒ‰
        maximumAge:0, // æ¯å›æ–°ã—ã„æƒ…å ±ã‚’å–å¾—
        timeout:10000 // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ10ç§’
    });
}

async function loadRanking(){
    let res = await fetch("https://area-battle.onrender.com/ranking");
    let data = await res.json();

    let text= "";
    let rank = 1;
    let crown = "";

    for(let r of data){
        if(rank == 1){
            crown = "ğŸ¥‡";
        }
        else if(rank == 2){
            crown = "ğŸ¥ˆ";
        }
        else if(rank == 3){
            crown = "ğŸ¥‰";
        }

        text += crown + rank + "ä½ " + r.username + " : " + r.area + "<br>";
        rank++;
    }
    document.getElementById("ranking").innerHTML = text;
}

// å®šæœŸçš„ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
setInterval(loadRanking, 10000); // 10ç§’ã”ã¨ã«æ›´æ–°
loadRanking(); // æœ€åˆã«ä¸€å›å®Ÿè¡Œ 

</script>

</body>
</html>