<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- スマホ対応 -->
<title>エリアバトル</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
    /* 全体設定 */
    body{
        margin:0;
        font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
        background:#eef1f5;
    }

    /* ヘッダー */
    .header{
        position:fixed;
        top:0;
        width:100%;
        background:white;
        text-align:center;
        padding:14px;
        font-weight:bold;
        font-size:18px;
        box-shadow:0 2px 8px rgba(0,0,0,0.1);
        z-index:1000;
    }

    /* コンテナ */
    .container{
        padding:70px 12px 20px;
        max-width:500px;
        margin:auto;
   }

    /* 地図 */
    #map{
        height:55vh;
        border-radius:14px;
        overflow:hidden;
        box-shadow:0 4px 12px rgba(0,0,0,0.12);
        margin-bottom:12px;
    }

    /* ボタン */
    button{
       width:100%;
        padding:14px;
        font-size:16px;
        border:none;    
        border-radius:12px;
        background:#007aff;
        color:white;
        font-weight:bold;
        margin-bottom:10px;
    }

    button:active{
        transform:scale(0.96);
    }

    /* 入力 */
    input{
        width:100%;
        padding:12px;
        border-radius:10px;
        border:none;
        margin-bottom:12px;
        font-size:15px;
    }

    /* カード */
    .card{
        background:white;
        padding:12px;
        border-radius:14px;
        margin-bottom:12px;
        box-shadow:0 2px 8px rgba(0,0,0,0.08);
    }

    /* ランキング */
    .rank-item{
        display:flex;
        justify-content:space-between;
        padding:10px;
        background:#f4f6f9;
        border-radius:10px;
        margin-bottom:6px;
    }

</style>
</head>

<body>

<div class="header">エリアバトル</div>
<div class="container">
    <div id="map" style="height:500px;"></div>
    <input id = "username" type="text" placeholder="名前を入力"/>
    <button onclick="startGPS()">GPS取得開始</button>    
    <button onclick="sendArea()">面積計算</button>
    <button onclick="resetMap()">地図リセット</button>

    <div id="result" class="card"></div>

    <div class="card">
        <h3>ランキング </h3>
        <div id="ranking"></div>
    </div>
</div>



<script>
// 地図を作る。福岡あたりを表示
let map = L.map('map',{
    dragging:true, // ドラッグ移動有効
    touchZoom:true,  // ピンチズーム有効
    scrollWheelZoom:true, // マウスホイールズーム有効
    doubleClickZoom:true, // ダブルクリックズーム有効
    boxZoom:true, // ドラッグでズーム範囲指定有効
    keyboard:true // キーボード操作有効
}).setView([33.59,130.40],13);

// サイズ再計算（スマホ画面表示崩れ防止）
window.addEventListener("resize",()=>{
    map.invalidateSize();
})

// 最初の1回だけ地図中心を現在地に移動する用
let firstMove = true;

// 無料地図を組み込む
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// 座標用の配列と、線オブジェクトを用意
let points = [];
let polyline = L.polyline([]).addTo(map);
let closeline = null;

// クリックで座標追加（テスト用）
/*map.on('click', function(e){
    points.push([e.latlng.lng, e.latlng.lat]);
    polyline.addLatLng(e.latlng); // 線を追加で伸ばす
});*/

let lastLat = null;
let lastLng = null;

// 簡易距離計算（※緯度経度の差の大きさ）
function distance(a,b,c,d){
    return Math.sqrt((a - c) ** 2 + (b - d) ** 2);
}

async function sendArea(){

    if(points.length < 3){
        alert("3点以上必要です");
        return;
    }

    // 既存の点線削除
    if(closeline){
        map.removeLayer(closeline);
        closeline = null;
    }

    // 始点終点を点線で結ぶ
    let start = points[0]
    let end = points[points.length-1];
    closeline = L.polyline([[start[1], start[0]], [end[1], end[0]]], 
    {
        dashArray:"8.8", // 点線
        color: 'red',
        weight:3
    }
    ).addTo(map);

    // 最初の点を最後に追加して、多角形を閉じる
    let sendPoints = [...points]; // 配列のコピー

    let first = sendPoints[0];
    let last = sendPoints[sendPoints.length-1];

    if(first[0] !== last[0] || first[1] !== last[1]){
        sendPoints.push(first); // 始点と終点が一致していなければ、ここで最初の点を最後に追加
    }

    // ユーザー名取得
    let name = document.getElementById("username").value;
    
    //　fetchで、サーバーにPOSTリクエストを送る
    let res = await fetch("https://area-battle.onrender.com/area",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            coords:sendPoints,
            name:name}) // 座標・名前データ送信(JS → JSON → Python)
    });

    let data = await res.json(); //　面積データ受信(Python → JSON → JS)
    // ↑ data = { "area": 面積の数値 } という構造で受け取れる
    document.getElementById("result").innerText =
        "面積: " + data.area;
}

function resetMap(){
    // GPS監視停止
    if(watchId !== null){
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }
    // 座標リストを空に
    points = [];
    lastLat = null;
    lastLng = null;
    firstMove = true;
    // 線を削除
    polyline.setLatLngs([]);
    // マーカーを削除
    if(marker){
        map.removeLayer(marker);
        marker = null;
    }
    // 点線を削除
    if(closeline){
        map.removeLayer(closeline);
        closeline = null;
    }
    // 結果表示をクリア
    document.getElementById("result").innerText = "";
}

// GPS関連
let watchId = null; // 監視ID
let marker = null; // 現在地マーカー

function startGPS(){

    // GPS対応確認
    if(!navigator.geolocation){
        alert("GPSがつかえないよ");
        return;
    }

    // GPS二重起動防止
    if(watchId){
        alert("すでに開始してるよ");
        return;
    }

    // 位置情報監視開始
    watchId = navigator.geolocation.watchPosition(function(pos){

        // lat: 緯度、lng: 経度を取得
        let lat = pos.coords.latitude;
        let lng = pos.coords.longitude;

        if(lastLat !== null){
            // あまりに近い場合は無視して追加しない（ノイズ対策）
            if(distance(lat,lng,lastLat,lastLng) < 0.00005){
                return;
            }
        }

        // 更新
        lastLat = lat;
        lastLng = lng;

        // 面積計算用の形式(経度、緯度)で配列に追加
        points.push([lng, lat]);

        // 地図表示用(緯度、経度)でマーカー表示
        polyline.addLatLng([lat, lng]);

        // 現在地マーカー更新
        if(marker){
            marker.setLatLng([lat, lng]);
        }else{
            marker = L.marker([lat, lng]).addTo(map);
        }

        // 地図中心を現在地に移動（初回のみ）
        if(firstMove){
            map.panTo([lat, lng]);
            firstMove = false;
        }
    },
    function(err){
        alert("位置情報取得失敗");
    },
    {
        enableHighAccuracy:true, // 高精度モード
        maximumAge:0, // 毎回新しい情報を取得
        timeout:10000 // タイムアウト10秒
    });
}

async function loadRanking(){
    let res = await fetch("https://area-battle.onrender.com/ranking");
    let data = await res.json();

    let text= "";
    for(let r of data){
        text += r.name + " : " + r.area + "<br>";
    }
    document.getElementById("ranking").innerHTML = text;
}

</script>

</body>
</html>